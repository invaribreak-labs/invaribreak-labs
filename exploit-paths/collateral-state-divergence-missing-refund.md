{
  "preconditions": [
    "TradePairs.sol and Portfolio.sol are deployed on an Ethereum test environment.",
    "Actor A (Maker) holds at least 1000 USDT in the Portfolio contract.",
    "Actor A places a limit buy order with price = 10 USDT and quantity = 100.",
    "Portfolio.lockCollateral records 1000 USDT as locked for Actor A, leaving available balance 0.",
    "Actor B (Taker) has a sell order that can match the buy order at execution price = 9 USDT, quantity = 100.",
    "The system follows the standard matchOrder flow (auction mode is not active)."
  ],
  "attack_vector": "Trigger the standard matchOrder execution where the execution price is lower than the maker's limit price, causing the surplus locked collateral to remain after the order is marked filled.",
  "step_by_step": [
    {
      "step": 1,
      "action": "Actor A submits the limit buy order (price 10 USDT, quantity 100) to TradePairs.",
      "expected_result": "Portfolio locks 1000 USDT for Actor A; available balance becomes 0."
    },
    {
      "step": 2,
      "action": "Actor B submits a matching sell order (price 9 USDT, quantity 100).",
      "expected_result": "Matching engine pairs the orders and invokes TradePairs.matchOrder."
    },
    {
      "step": 3,
      "action": "TradePairs.matchOrder calls Portfolio.addExecution with execution price 9 USDT and quantity 100.",
      "expected_result": "Portfolio transfers 900 USDT from Actor A's locked collateral to Actor B and reduces the locked amount by 900."
    },
    {
      "step": 4,
      "action": "TradePairs.matchOrder marks the buy order as FILLED and removes it from the open‑order list without invoking any surplus‑adjustment routine.",
      "expected_result": "Actor A's locked collateral remains at 100 USDT while no open orders exist."
    },
    {
      "step": 5,
      "action": "Query the Portfolio state for Actor A.",
      "expected_result": "Portfolio shows total = 100 USDT, available = 0 USDT, locked = 100 USDT, confirming the state divergence."
    }
  ],
  "postconditions": [
    "Actor A's locked collateral (100 USDT) does not correspond to any active order.",
    "Invariant INV-001-collateral-consistency is violated: locked ≠ Σ(openOrders price × quantity).",
    "The surplus 100 USDT remains locked in the Portfolio contract for Actor A."
  ]
}