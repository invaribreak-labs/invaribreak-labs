{
  "preconditions": [
    "A flash‑loan provider contract capable of lending the target borrowable asset (e.g., WETH).",
    "A Uniswap V2 pair contract that serves as the spot‑price source for the asset in BaseOracle.",
    "The BaseOracle contract deployed with the spot‑price function quoteUsdValueFromAMMPool and a TWAP aggregator returning a stable price.",
    "A borrowing contract (e.g., SmartLoan) that queries BaseOracle for the asset price and enforces collateral checks based on the returned final price.",
    "A test contract (Validator) that can receive a flash loan, perform token swaps on the Uniswap V2 pair, and invoke the borrowing contract within a single transaction."
  ],
  "attack_vector": "Manipulation of the spot price via a flash‑loan‑driven swap followed by a borrowing request that relies on BaseOracle's min(spot, TWAP) selection.",
  "step_by_step": [
    {
      "step": 1,
      "action": "Validator calls the flash‑loan provider to borrow a large amount of the target asset.",
      "expected_result": "Validator receives the flash‑loaned tokens in the same transaction."
    },
    {
      "step": 2,
      "action": "Validator swaps the borrowed tokens into the Uniswap V2 pair used by BaseOracle, selling the asset for the paired token to depress the on‑chain reserve ratio.",
      "expected_result": "The spot price reported by getReserves() drops significantly (e.g., to near‑zero)."
    },
    {
      "step": 3,
      "action": "Validator invokes the borrowing contract’s borrow function for the same asset.",
      "expected_result": "BaseOracle computes finalDollarValue = Math.min(spotPrice, twapPrice); with the manipulated spotPrice, finalDollarValue equals the low spot price."
    },
    {
      "step": 4,
      "action": "Borrowing contract evaluates the collateral requirement using the low finalDollarValue and approves a loan amount that would be disallowed under the TWAP price.",
      "expected_result": "Validator receives a loan amount substantially larger than what the collateral would support under the TWAP reference."
    },
    {
      "step": 5,
      "action": "Validator repays the flash loan plus any required fee to the flash‑loan provider.",
      "expected_result": "Flash loan is settled; the transaction completes without reversion."
    }
  ],
  "postconditions": [
    "The borrowing contract records a loan whose valuation is based on the manipulated spot price.",
    "The flash loan is fully repaid, leaving the system state unchanged except for the increased debt position.",
    "A single transaction demonstrates that the oracle’s min‑selection logic can be driven to a lower price than the TWAP, confirming the break point identified in Day 1."
  ]
}